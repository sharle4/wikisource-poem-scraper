<!DOCTYPE html>
<html lang="fr" class="h-full bg-slate-50 dark:bg-slate-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorateur de Corpus Poétique</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .poem-text { font-family: 'Merriweather', serif; white-space: pre-line; }
        .view { display: none; }
        .view.active { display: block; }
        #drop-zone.drag-over { border-color: #3b82f6; background-color: #eff6ff; }
        .dark #drop-zone.drag-over { border-color: #60a5fa; background-color: #1e293b; }
        .list-item { transition: background-color 0.2s ease-in-out; }
        .list-item:hover { background-color: #f3f4f6; }
        .dark .list-item:hover { background-color: #1f2937; }
        #controls-view { display: none; }
        #list-view.active ~ #controls-view { display: flex; }
    </style>
</head>
<body class="h-full text-slate-800 dark:text-slate-200 antialiased">

    <div id="app" class="flex flex-col h-full">
        <!-- ===== Header ===== -->
        <header class="bg-white dark:bg-slate-800/50 backdrop-blur-sm border-b border-slate-200 dark:border-slate-700 p-4 shadow-sm sticky top-0 z-10">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <h1 class="text-xl font-bold text-slate-900 dark:text-white">Explorateur de Corpus</h1>
                <nav id="breadcrumbs" class="text-sm text-slate-500 dark:text-slate-400 hidden"></nav>
            </div>
        </header>

        <!-- ===== Controls Bar ===== -->
         <div id="controls-view" class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm border-b border-slate-200 dark:border-slate-700 p-3 sticky top-[65px] z-10">
            <div class="max-w-7xl mx-auto flex items-center gap-4">
            </div>
        </div>

        <!-- ===== Main Content ===== -->
        <main class="flex-grow overflow-y-auto p-4 md:p-8">
            <div class="max-w-7xl mx-auto">
                <!-- Vues de l'application -->
                <div id="upload-view" class="view active"></div>
                <div id="home-view" class="view"></div>
                <div id="list-view" class="view"></div>
                <div id="poem-view" class="view"></div>
            </div>
        </main>
    </div>

    <!-- ===== Templates (pour le clonage) ===== -->
    <template id="upload-template">
        <div class="text-center">
            <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">Bienvenue</h2>
            <p class="text-lg text-slate-600 dark:text-slate-400 mb-8">Chargez un fichier <code class="bg-slate-200 dark:bg-slate-700 text-sm px-2 py-1 rounded-md">poems.cleaned.jsonl.gz</code> pour commencer.</p>
            <div id="drop-zone" class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-12 cursor-pointer max-w-2xl mx-auto">
                <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h5l4 4h2a4 4 0 014 4v5a4 4 0 01-4 4H7z"></path></svg>
                <p class="mt-2 font-semibold">Déposez votre fichier ici ou cliquez pour sélectionner</p>
                <input type="file" id="file-input" class="hidden" accept=".gz,.jsonl">
            </div>
            <div id="loading-feedback" class="mt-6 text-slate-500 dark:text-slate-400"></div>
        </div>
    </template>

    <template id="home-card-template">
        <a href="#" class="block bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
            <div class="flex items-center space-x-4">
                <div class="p-3 bg-indigo-100 dark:bg-indigo-900/50 rounded-lg">
                    <svg class="w-6 h-6 text-indigo-600 dark:text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"></svg>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white"></h3>
                    <p class="text-slate-500 dark:text-slate-400"></p>
                </div>
            </div>
        </a>
    </template>
    
    <template id="list-item-template">
         <a href="#" class="list-item flex items-start justify-between p-4 border-b border-slate-200 dark:border-slate-700 last:border-b-0">
            <div class="flex-grow">
                <p class="font-semibold text-indigo-600 dark:text-indigo-400"></p>
                <div class="item-meta text-sm text-slate-500 dark:text-slate-400 space-x-4"></div>
            </div>
            <div class="flex-shrink-0 ml-4">
                 <svg class="w-5 h-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </div>
        </a>
    </template>
    
    <template id="controls-template">
        <div class="flex-grow relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="w-5 h-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            <input type="search" id="filter-input" placeholder="Rechercher..." class="w-full md:w-96 bg-slate-100 dark:bg-slate-700 p-2 pl-10 rounded-md border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
        </div>
        <div class="flex items-center gap-2">
            <label for="sort-by" class="text-sm font-medium">Trier par :</label>
            <select id="sort-by" class="bg-slate-100 dark:bg-slate-700 p-2 rounded-md border border-slate-300 dark:border-slate-600"></select>
        </div>
        <div class="flex items-center gap-2">
             <label for="sort-order" class="text-sm font-medium">Ordre :</label>
            <select id="sort-order" class="bg-slate-100 dark:bg-slate-700 p-2 rounded-md border border-slate-300 dark:border-slate-600">
                <option value="asc">Ascendant</option>
                <option value="desc">Descendant</option>
            </select>
        </div>
    </template>

    <!-- ===== Worker script ===== -->
    <script id="data-worker" type="javascript/worker">
        self.onmessage = (event) => {
            const fileContent = event.data;
            try {
                postMessage({ status: 'parsing' });
                const poems = fileContent.trim().split('\n').map(line => JSON.parse(line));
                
                postMessage({ status: 'indexing' });
                const db = { 
                    poems: new Map(poems.map(p => [p.page_id, p])),
                    authors: new Map(),
                    collections: new Map() 
                };

                poems.forEach(p => {
                    const authorName = p.metadata.author || 'Auteur Inconnu';
                    if (!db.authors.has(authorName)) {
                        db.authors.set(authorName, {
                            name: authorName,
                            collections: new Map(),
                            poemsWithoutCollection: []
                        });
                    }
                    const author = db.authors.get(authorName);

                    const collectionId = p.collection_page_id;
                    if (collectionId) {
                        if (!db.collections.has(collectionId)) {
                             db.collections.set(collectionId, { 
                                id: collectionId,
                                title: p.collection_title,
                                author: authorName,
                                poems: [] 
                            });
                        }
                        const collection = db.collections.get(collectionId);
                        collection.poems.push(p);

                        if (!author.collections.has(collectionId)) {
                            author.collections.set(collectionId, collection);
                        }
                    } else {
                        author.poemsWithoutCollection.push(p);
                    }
                });

                // Trier les poèmes dans chaque recueil
                for(const collection of db.collections.values()) {
                    collection.poems.sort((a, b) => (a.poem_order || 0) - (b.poem_order || 0));
                }

                postMessage({ status: 'done', db });
            } catch (error) { postMessage({ status: 'error', error: error.message }); }
        };
    </script>

    <!-- ===== Application script ===== -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const App = {
            db: null,
            views: {
                upload: document.getElementById('upload-view'),
                home: document.getElementById('home-view'),
                list: document.getElementById('list-view'),
                poem: document.getElementById('poem-view'),
            },
            controlsView: document.getElementById('controls-view'),
            breadcrumbsEl: document.getElementById('breadcrumbs'),
            
            viewStates: {
                authors: { query: '', sortKey: 'name', sortOrder: 'asc' },
                collections: { query: '', sortKey: 'title', sortOrder: 'asc' },
                poems: { query: '', sortKey: 'title', sortOrder: 'asc' },
                author: { query: '', sortKey: 'title', sortOrder: 'asc' },
                collection: { query: '', sortKey: 'poem_order', sortOrder: 'asc' },
            },
            currentViewType: null,
            lastControlsViewType: null,

            init() {
                this.renderUploadView();
                window.addEventListener('hashchange', () => this.router());
                this.router();
            },

            router() {
                const hash = window.location.hash || '#';
                const [path, param] = hash.substring(1).split('/');
                
                this.updateBreadcrumbs(hash);
                if (!this.db && path !== '') {
                    window.location.hash = '#';
                    return;
                }
                
                Object.values(this.views).forEach(v => v.classList.remove('active'));
                this.currentViewType = path;
                
                const listViews = ['authors', 'collections', 'poems', 'author', 'collection'];

                if (listViews.includes(path)) {
                    this.views.list.classList.add('active');
                    this.controlsView.style.display = 'flex';
                } else {
                    this.controlsView.style.display = 'none';
                    this.lastControlsViewType = null;
                }

                switch (path) {
                    case 'authors':
                        this.renderList('authors', 'Auteurs', this.db.authors, this.renderAuthorListItem,
                            [{key: 'name', label: 'Nom'}, {key: 'poemCount', label: 'Nb. poèmes'}]);
                        break;
                    case 'author': this.renderAuthorDetail(decodeURIComponent(param)); break;
                    case 'collections':
                        this.renderList('collections', 'Recueils', this.db.collections, this.renderCollectionListItem,
                            [{key: 'title', label: 'Titre'}, {key: 'poemCount', label: 'Nb. poèmes'}]);
                        break;
                    case 'collection': this.renderCollectionDetail(parseInt(param)); break;
                    case 'poems':
                        this.renderList('poems', 'Tous les poèmes', this.db.poems, this.renderPoemListItem,
                            [{key: 'title', label: 'Titre'}, {key: 'author', label: 'Auteur'}, {key: 'publication_date', label: 'Date'}]);
                        break;
                    case 'poem': this.views.poem.classList.add('active'); this.renderPoemDetail(parseInt(param)); break;
                    case 'home': this.views.home.classList.add('active'); break;
                    default:
                        if (this.db) { window.location.hash = '#home'; this.views.home.classList.add('active'); }
                        else this.views.upload.classList.add('active');
                }
            },
            
            setupUploadEvents() {
                const dropZone = document.getElementById('drop-zone');
                const fileInput = document.getElementById('file-input');
                dropZone.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', (e) => this.handleFile(e.target.files[0]));
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, (ev) => { ev.preventDefault(); ev.stopPropagation(); }));
                ['dragenter', 'dragover'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.add('drag-over')));
                ['dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.remove('drag-over')));
                dropZone.addEventListener('drop', (e) => this.handleFile(e.dataTransfer.files[0]));
            },

            handleFile(file) {
                if (!file) return;
                const feedbackEl = document.getElementById('loading-feedback');
                feedbackEl.textContent = 'Chargement du fichier...';
                const reader = new FileReader();
                reader.onload = (event) => {
                    feedbackEl.textContent = 'Décompression...';
                    try {
                        const decompressed = pako.inflate(new Uint8Array(event.target.result), { to: 'string' });
                        this.processData(decompressed);
                    } catch (err) { feedbackEl.textContent = `Erreur: ${err.message}`; }
                };
                reader.readAsArrayBuffer(file);
            },
            
            processData(fileContent) {
                const worker = new Worker(URL.createObjectURL(new Blob([document.getElementById('data-worker').textContent])));
                const feedbackEl = document.getElementById('loading-feedback');
                worker.onmessage = (event) => {
                    const { status, db, error } = event.data;
                    switch (status) {
                        case 'parsing': feedbackEl.textContent = 'Analyse des données...'; break;
                        case 'indexing': feedbackEl.textContent = 'Indexation du corpus...'; break;
                        case 'done':
                            this.db = db;
                            this.renderHomeView();
                            window.location.hash = '#home';
                            break;
                        case 'error': feedbackEl.textContent = `Erreur: ${error}`; break;
                    }
                };
                worker.postMessage(fileContent);
            },

            renderControls(viewType, sortOptions) {
                const controlsContainer = this.controlsView.querySelector('div');
                controlsContainer.innerHTML = document.getElementById('controls-template').innerHTML;
                const state = this.viewStates[viewType];
                const filterInput = controlsContainer.querySelector('#filter-input');
                filterInput.value = state.query;
                filterInput.addEventListener('input', (e) => {
                    state.query = e.target.value;
                    this.updateListView(); 
                });
                const sortBySelect = controlsContainer.querySelector('#sort-by');
                sortOptions.forEach(opt => {
                    const optionEl = document.createElement('option');
                    optionEl.value = opt.key;
                    optionEl.textContent = opt.label;
                    sortBySelect.appendChild(optionEl);
                });
                sortBySelect.value = state.sortKey;
                sortBySelect.addEventListener('change', (e) => {
                    state.sortKey = e.target.value;
                    this.updateListView();
                });
                const sortOrderSelect = controlsContainer.querySelector('#sort-order');
                sortOrderSelect.value = state.sortOrder;
                sortOrderSelect.addEventListener('change', (e) => {
                    state.sortOrder = e.target.value;
                    this.updateListView();
                });
            },
            
            updateListView() {
                const [path, param] = (window.location.hash || '#').substring(1).split('/');
                const viewDetails = this.getViewDetails(path, param);
                if (!viewDetails) return;

                const { viewType, title, data, itemRenderer, searchKey } = viewDetails;
                
                let items = Array.from(data.values());
                items = this.applyFilterAndSort(items, viewType, searchKey);
                
                document.querySelector('#list-view h2').textContent = `${title} (${items.length})`;
                const container = document.getElementById('list-container');
                container.innerHTML = '';
                
                if (items.length === 0) {
                    container.innerHTML = `<p class="p-4 text-slate-500 italic">Aucun résultat trouvé.</p>`;
                } else {
                    items.forEach(item => container.appendChild(itemRenderer.call(this, item)));
                }
            },

            applyFilterAndSort(items, viewType, searchKey) {
                const state = this.viewStates[viewType];
                const query = state.query.toLowerCase();
                if (query) {
                    items = items.filter(item => (item[searchKey] || '').toLowerCase().includes(query));
                }
                const sortKey = state.sortKey;
                const sortOrder = state.sortOrder === 'asc' ? 1 : -1;
                items.sort((a, b) => {
                    let valA, valB;
                    if (sortKey === 'poemCount') {
                        valA = a.poems?.length || a.collections?.size || 0;
                        valB = b.poems?.length || b.collections?.size || 0;
                        if(a.poemsWithoutCollection) valA += a.poemsWithoutCollection.length;
                        if(b.poemsWithoutCollection) valB += b.poemsWithoutCollection.length;

                    } else if (sortKey === 'author') {
                        valA = a.metadata?.author;
                        valB = b.metadata?.author;
                    } else if (sortKey === 'publication_date') {
                        valA = a.metadata?.publication_date || 0;
                        valB = b.metadata?.publication_date || 0;
                    } else {
                        valA = a[sortKey];
                        valB = b[sortKey];
                    }

                    valA = valA || ''; valB = valB || '';
                    if (typeof valA === 'string') return valA.localeCompare(valB) * sortOrder;
                    if (typeof valA === 'number') return (valA - valB) * sortOrder;
                    return 0;
                });
                return items;
            },

            renderUploadView() {
                this.views.upload.innerHTML = document.getElementById('upload-template').innerHTML;
                this.setupUploadEvents();
            },
            
            renderHomeView() {
                this.views.home.innerHTML = '';
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6';
                const homeCards = [
                    { href: '#authors', title: 'Auteurs', count: `${this.db.authors.size} auteurs`, svgPath: 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-1a6 6 0 00-5.197-5.977' },
                    { href: '#collections', title: 'Recueils', count: `${this.db.collections.size} recueils`, svgPath: 'M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z' },
                    { href: '#poems', title: 'Tous les poèmes', count: `${this.db.poems.size} poèmes`, svgPath: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z' }
                ];
                homeCards.forEach(card => {
                    const node = document.getElementById('home-card-template').content.cloneNode(true);
                    const link = node.querySelector('a');
                    link.href = card.href;
                    link.querySelector('h3').textContent = card.title;
                    link.querySelector('p').textContent = card.count;
                    link.querySelector('svg').innerHTML = `<path stroke-linecap="round" stroke-width="2" d="${card.svgPath}"/>`;
                    grid.appendChild(node);
                });
                this.views.home.appendChild(grid);
            },
            
            renderList(viewType, title, data, itemRenderer, sortOptions) {
                if (viewType !== this.lastControlsViewType) {
                    this.renderControls(viewType, sortOptions);
                    this.lastControlsViewType = viewType;
                }
                
                this.views.list.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white"></h2>
                    <div class="bg-white dark:bg-slate-800 rounded-lg shadow-md overflow-hidden">
                        <div id="list-container"></div>
                    </div>
                `;
                this.updateListView();
            },
            
            getViewDetails(path, param) {
                switch (path) {
                    case 'authors': return { viewType: 'authors', title: 'Auteurs', data: this.db.authors, itemRenderer: this.renderAuthorListItem, searchKey: 'name'};
                    case 'collections': return { viewType: 'collections', title: 'Recueils', data: this.db.collections, itemRenderer: this.renderCollectionListItem, searchKey: 'title'};
                    case 'poems': return { viewType: 'poems', title: 'Tous les poèmes', data: this.db.poems, itemRenderer: this.renderPoemListItem, searchKey: 'title'};
                    case 'collection': 
                        const collection = this.db.collections.get(parseInt(param));
                        return collection ? { viewType: 'collection', title: collection.title, data: collection.poems, itemRenderer: this.renderPoemListItem, searchKey: 'title' } : null;
                    case 'author':
                         const author = this.db.authors.get(decodeURIComponent(param));
                         return author ? { viewType: 'author', title: author.name, data: author.collections, itemRenderer: this.renderCollectionListItem, searchKey: 'title'} : null;
                }
                return null;
            },

            renderAuthorListItem(author) {
                const node = document.getElementById('list-item-template').content.cloneNode(true);
                const link = node.querySelector('a');
                link.href = `#author/${encodeURIComponent(author.name)}`;
                link.querySelector('p').textContent = author.name;
                const collectionCount = author.collections.size;
                const poemCount = [...author.collections.values()].reduce((sum, coll) => sum + coll.poems.length, 0) + author.poemsWithoutCollection.length;
                link.querySelector('.item-meta').innerHTML = `<span>${poemCount} poèmes</span><span>${collectionCount} recueils</span>`;
                return node;
            },
            renderCollectionListItem(collection) {
                const node = document.getElementById('list-item-template').content.cloneNode(true);
                const link = node.querySelector('a');
                link.href = `#collection/${collection.id}`;
                link.querySelector('p').textContent = collection.title;
                link.querySelector('.item-meta').innerHTML = `<span>Par ${collection.author}</span><span>${collection.poems.length} poèmes</span>`;
                return node;
            },
            renderPoemListItem(poem, collectionContext) {
                const node = document.getElementById('list-item-template').content.cloneNode(true);
                const link = node.querySelector('a');
                link.href = `#poem/${poem.page_id}`;

                let titleHtml = '';
                if(collectionContext && poem.section_title && (poem.poem_order === 0 || collectionContext[poem.poem_order - 1]?.section_title !== poem.section_title)) {
                    titleHtml += `<div class="text-xs font-bold uppercase text-slate-400 dark:text-slate-500 pt-3 pb-1">${poem.section_title}</div>`;
                }
                titleHtml += `<p class="font-semibold text-indigo-600 dark:text-indigo-400">${poem.title}</p>`;

                const container = node.querySelector('.flex-grow');
                container.innerHTML = titleHtml;

                const meta = document.createElement('div');
                meta.className = 'item-meta text-sm text-slate-500 dark:text-slate-400 space-x-4';
                const author = poem.metadata.author || 'Inconnu';
                const date = poem.metadata.publication_date || '';
                meta.innerHTML = `<span>${author}</span><span>${date}</span>`;
                container.appendChild(meta);
                
                return node;
            },
            
            renderAuthorDetail(authorName) {
                const author = this.db.authors.get(authorName);
                if (!author) { this.views.list.innerHTML = '<p>Auteur non trouvé.</p>'; return; }

                const sortOptions = [{ key: 'title', label: 'Titre' }, {key: 'poemCount', label: 'Nb. poèmes'}];
                this.renderList('author', null, null, null, sortOptions);
            },
            
            renderCollectionDetail(collectionId) {
                const collection = this.db.collections.get(collectionId);
                if (!collection) { this.views.list.innerHTML = '<p>Recueil non trouvé.</p>'; return; }

                const customPoemRenderer = (poem) => this.renderPoemListItem(poem, collection.poems);
                
                const viewType = 'collection';
                if (viewType !== this.lastControlsViewType) {
                    this.renderControls(viewType, [{ key: 'poem_order', label: 'Ordre du recueil' }, { key: 'title', label: 'Titre' }]);
                    this.lastControlsViewType = viewType;
                }

                this.views.list.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white"></h2>
                    <div class="bg-white dark:bg-slate-800 rounded-lg shadow-md overflow-hidden">
                        <div id="list-container"></div>
                    </div>`;

                const state = this.viewStates.collection;
                let items = [...collection.poems];
                if (state.sortKey === 'title') {
                    items.sort((a,b) => a.title.localeCompare(b.title) * (state.sortOrder === 'asc' ? 1 : -1));
                }
                document.querySelector('#list-view h2').textContent = `${collection.title} (${items.length})`;
                const container = document.getElementById('list-container');
                container.innerHTML = '';
                items.forEach(item => container.appendChild(customPoemRenderer(item)));
            },
            
            renderPoemDetail(pageId) {
                const poem = this.db.poems.get(pageId);
                const meta = poem.metadata;
                this.views.poem.innerHTML = `
                    <div class="bg-white dark:bg-slate-800 p-6 md:p-8 rounded-lg shadow-lg">
                        <h2 class="text-3xl font-bold text-slate-900 dark:text-white font-serif">${poem.title}</h2>
                        <p class="text-lg text-slate-500 dark:text-slate-400 mt-1 mb-6">par ${meta.author || 'Auteur inconnu'}</p>
                        <div class="text-sm text-slate-600 dark:text-slate-300 border-t border-b py-4 mb-8 grid grid-cols-2 md:grid-cols-4 gap-4">
                            ${poem.collection_title ? `<div><strong class="block text-slate-500">Recueil</strong> <a href="#collection/${poem.collection_page_id}" class="text-indigo-600 hover:underline">${poem.collection_title}</a></div>` : ''}
                            ${poem.section_title ? `<div><strong class="block text-slate-500">Section</strong> ${poem.section_title}</div>` : ''}
                            ${meta.publication_date ? `<div><strong class="block text-slate-500">Publié en</strong> ${meta.publication_date}</div>` : ''}
                             <div><strong class="block text-slate-500">Source</strong> <a href="${poem.wikisource_url}" target="_blank" class="text-indigo-600 hover:underline">Wikisource</a></div>
                        </div>
                        <div class="poem-text text-lg leading-relaxed">${poem.structure.stanzas.map(s => `<div>${s.join('<br>')}</div>`).join('<br><br>')}</div>
                    </div>`;
            },
            
            updateBreadcrumbs(hash) {
                this.breadcrumbsEl.classList.remove('hidden');
                const parts = hash.substring(1).split('/').map(decodeURIComponent);
                let path = '#';
                const homeLink = `<a href="#home" class="hover:text-indigo-600">Accueil</a>`;
                if (hash === '#' || hash === '#home' || parts[0] === '') { this.breadcrumbsEl.innerHTML = homeLink; return; }

                const links = parts.map((part, i) => {
                    path += (i === 0 ? '' : '/') + encodeURIComponent(part);
                    const isLast = i === parts.length - 1;
                    const item = this.getBreadcrumbItem(parts[0], part);
                    if (isLast) return `<span class="font-semibold text-slate-700 dark:text-slate-200">${item}</span>`;
                    return `<a href="${path}" class="hover:text-indigo-600">${item}</a>`;
                });
                this.breadcrumbsEl.innerHTML = `${homeLink} <span class="mx-2">/</span> ${links.join('<span class="mx-2">/</span>')}`;
            },

            getBreadcrumbItem(type, value) {
                try {
                    switch(type) {
                        case 'author': return this.db.authors.get(value)?.name || value;
                        case 'collection': return this.db.collections.get(parseInt(value))?.title || value;
                        case 'poem': return this.db.poems.get(parseInt(value))?.title || value;
                        default: return {authors: 'Auteurs', collections: 'Recueils', poems: 'Poèmes'}[type] || value;
                    }
                } catch { return value; }
            }
        };

        App.init();
    });
    </script>

</body>
</html>