<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualiseur d'Arbre d'Exploration Interactif</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --text-color: #333;
            --header-bg: #fff;
            --border-color: #dee2e6;
            --link-color: #0d6efd;
            --tooltip-bg: rgba(33, 37, 41, 0.9);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        #top-bar, #controls {
            padding: 10px 20px;
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        h1 { margin: 0; font-size: 1.3em; color: #212529; }
        .control-group { display: flex; align-items: center; gap: 8px; font-size: 0.9em; }
        label, .control-group span { font-weight: 500; color: #495057; }
        select, input[type="text"] { padding: 4px 8px; border: 1px solid #ced4da; border-radius: 4px; }
        #file-input-label {
            display: inline-block;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 4px;
            background-color: var(--link-color);
            color: white;
            font-weight: 500;
            border: none;
        }
        #info-panel { font-size: 0.9em; color: #6c757d; white-space: nowrap; }
        #chart-container { flex-grow: 1; position: relative; }
        svg { width: 100%; height: 100%; cursor: grab; }
        .node circle { cursor: pointer; stroke-width: 2px; }
        .node text {
            font-size: 11px;
            paint-order: stroke;
            stroke: var(--bg-color);
            stroke-width: 3.5px;
            stroke-linecap: butt;
            stroke-linejoin: round;
        }
        .node a { text-decoration: none; fill: #212529; }
        .node a:hover text { text-decoration: underline; }
        .link { fill: none; stroke: #adb5bd; stroke-opacity: 0.6; stroke-width: 1.5px; }
        .tooltip {
            position: absolute;
            background-color: var(--tooltip-bg);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 350px;
            line-height: 1.4;
        }
        body.dragging-over #chart-container::before {
            content: 'DÃ©posez le fichier JSON ici';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(13, 110, 253, 0.85);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            font-weight: bold;
            border: 4px dashed #fff;
            z-index: 10;
        }
        #summary-panel { flex-grow: 1; display: flex; justify-content: flex-end; gap: 15px; font-size: 0.9em;}
        .summary-item { display: inline-flex; align-items: center; }
        .summary-color-box {
            width: 12px;
            height: 12px;
            margin-right: 5px;
            border-radius: 2px;
            border: 1px solid rgba(0,0,0,0.2);
        }

    </style>
</head>
<body>
    <div id="top-bar">
        <h1>Visualiseur d'Arbre Wikisource</h1>
        <label id="file-input-label">Charger un fichier JSON</label>
        <input type="file" id="file-input" accept=".json" style="display: none;">
        <div id="info-panel">Veuillez charger un fichier pour commencer.</div>
        <div class="control-group" style="margin-left: auto;">
             <label for="lang-input">Langue :</label>
             <input type="text" id="lang-input" value="fr" size="3">
        </div>
    </div>
    <div id="controls">
        <div class="control-group">
            <span>Filtrer par type :</span>
            <div id="type-filters"></div>
        </div>
        <div class="control-group">
            <label for="sort-by">Trier par :</label>
            <select id="sort-by">
                <option value="name">Nom</option>
                <option value="timestamp">Date</option>
                <option value="childCount">Nombre d'enfants</option>
            </select>
            <select id="sort-order">
                <option value="asc">Ascendant</option>
                <option value="desc">Descendant</option>
            </select>
        </div>
        <div id="summary-panel"></div>
    </div>
    <div id="chart-container">
        <svg id="chart"></svg>
    </div>
    <div class="tooltip" id="tooltip"></div>

    <script>
        const dropZone = document.body;
        let dragCounter = 0;
        dropZone.addEventListener('dragenter', (e) => {
            e.preventDefault();
            dragCounter++;
            dropZone.classList.add('dragging-over');
        });
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); }); // Essential for drop to work
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dragCounter--;
            if (dragCounter === 0) {
                dropZone.classList.remove('dragging-over');
            }
        });
        dropZone.addEventListener('drop', handleDrop);

        document.getElementById('file-input-label').addEventListener('click', () => document.getElementById('file-input').click());
        document.getElementById('file-input').addEventListener('change', handleFileSelect);
        document.getElementById('sort-by').addEventListener('change', applyFiltersAndSort);
        document.getElementById('sort-order').addEventListener('change', applyFiltersAndSort);

        const colorScale = d3.scaleOrdinal()
            .domain(["POEM", "POETIC_COLLECTION", "MULTI_VERSION_HUB", "OTHER", "AUTHOR"])
            .range(["#28a745", "#0d6efd", "#6f42c1", "#6c757d", "#fd7e14"]);
        
        const tooltip = d3.select("#tooltip");
        let originalData, currentRoot;
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) processFile(file);
        }

        function handleDrop(event) {
            event.preventDefault();
            dragCounter = 0;
            dropZone.classList.remove('dragging-over');
            if (event.dataTransfer.files.length) {
                processFile(event.dataTransfer.files[0]);
            }
        }

        function processFile(file) {
            if (!file || !file.type.match('application/json')) {
                alert("Veuillez utiliser un fichier JSON valide.");
                return;
            }
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    originalData = JSON.parse(e.target.result);
                    calculateAndDisplaySummary(originalData);
                    setupTypeFilters(originalData);
                    applyFiltersAndSort();
                } catch (error) {
                    alert("Erreur lors de la lecture du fichier JSON. Assurez-vous que le format est correct.");
                    console.error(error);
                }
            };
            reader.readAsText(file);
        }

        function calculateAndDisplaySummary(data) {
            const counts = {};
            const hierarchy = d3.hierarchy(data);
            hierarchy.each(d => {
                const type = d.data.type;
                if (type) counts[type] = (counts[type] || 0) + 1;
            });

            const summaryContainer = d3.select("#summary-panel");
            summaryContainer.html("");
            summaryContainer.append("span").text("Bilan :");

            colorScale.domain().forEach(type => {
                if (counts[type]) {
                    const item = summaryContainer.append("span").attr("class", "summary-item");
                    item.append("div")
                        .attr("class", "summary-color-box")
                        .style("background-color", colorScale(type));
                    item.append("span").text(`${type}: ${counts[type]}`);
                }
            });
        }

        function setupTypeFilters(data) {
            const types = new Set();
            d3.hierarchy(data).each(d => types.add(d.data.type));
            
            const filterContainer = d3.select("#type-filters");
            filterContainer.html("");
            types.forEach(type => {
                const label = filterContainer.append("label").style("display", "inline-flex").style("align-items", "center").style("margin-right", "10px");
                label.append("input")
                    .attr("type", "checkbox")
                    .attr("checked", true)
                    .attr("id", `filter-${type}`)
                    .on("change", applyFiltersAndSort);
                label.append("span")
                    .style("margin-left", "4px")
                    .style("color", colorScale(type))
                    .text(type);
            });
        }

        function applyFiltersAndSort() {
            if (!originalData) return;
            
            const activeTypes = new Set();
            d3.selectAll("#type-filters input").each(function() {
                if (this.checked) activeTypes.add(this.id.replace("filter-", ""));
            });

            const dataCopy = JSON.parse(JSON.stringify(originalData));

            function filter(node) {
                if (node.children) node.children = node.children.filter(filter);
                return activeTypes.has(node.type) || (node.children && node.children.length > 0);
            }
            filter(dataCopy);

            const sortBy = document.getElementById('sort-by').value;
            const sortOrder = document.getElementById('sort-order').value === 'asc' ? 1 : -1;

            function sortNodes(node) {
                if (node.children) {
                    node.children.sort((a, b) => {
                        let valA, valB;
                        if (sortBy === 'childCount') {
                            valA = a.children?.length || 0;
                            valB = b.children?.length || 0;
                        } else {
                            valA = a[sortBy] || (sortOrder === 1 ? Infinity : -Infinity);
                            valB = b[sortBy] || (sortOrder === 1 ? Infinity : -Infinity);
                        }
                        if (valA < valB) return -1 * sortOrder;
                        if (valA > valB) return 1 * sortOrder;
                        return 0;
                    });
                    node.children.forEach(sortNodes);
                }
            }
            sortNodes(dataCopy);
            
            document.getElementById('info-panel').innerHTML = `
                <strong>Auteur :</strong> ${dataCopy.name} | 
                <strong>Pages directes :</strong> ${dataCopy.direct_children} | 
                <strong>Total descendants :</strong> ${dataCopy.total_descendants}
            `;
            renderTree(dataCopy);
        }
        
        function renderTree(data) {
            const container = document.getElementById('chart-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            const margin = { top: 30, right: 250, bottom: 30, left: 120 };

            const svg = d3.select("#chart").html("").attr("viewBox", [0, 0, width, height]);
            const g = svg.append("g");
            
            const zoom = d3.zoom().scaleExtent([0.1, 5]).on("zoom", (event) => g.attr("transform", event.transform));
            svg.call(zoom.transform, d3.zoomIdentity.translate(margin.left, height / 2));
            svg.call(zoom);


            const dx = 25;
            const dy = width / 4;
            const tree = d3.tree().nodeSize([dx, dy]);
            
            currentRoot = d3.hierarchy(data, d => d.children);
            currentRoot.x0 = 0;
            currentRoot.y0 = 0;
            
            currentRoot.descendants().forEach((d, index) => {
                d.id = index;
                d._children = d.children;
                if (d.depth > 0) d.children = null;
            });

            update(currentRoot);

            function update(source) {
                const duration = 250;
                
                tree(currentRoot);

                const nodes = currentRoot.descendants();
                const links = currentRoot.links();
                
                const transition = g.transition().duration(duration);

                const node = g.selectAll("g.node").data(nodes, d => d.id);

                const nodeEnter = node.enter().append("g")
                    .attr("class", "node")
                    .attr("transform", `translate(${source.y0},${source.x0})`)
                    .attr("fill-opacity", 0)
                    .attr("stroke-opacity", 0)
                    .on("click", (event, d) => {
                        event.stopPropagation();
                        d.children = d.children ? null : d._children;
                        update(d);
                    });

                nodeEnter.append("circle")
                    .attr("r", 4.5)
                    .attr("stroke", d => colorScale(d.data.type))
                    .attr("fill", d => d._children ? colorScale(d.data.type) : "#fff");

                const textLink = nodeEnter.append("a")
                    .attr("xlink:href", d => `https://${document.getElementById('lang-input').value}.wikisource.org/wiki/${encodeURIComponent(d.data.name.replace(/ /g, '_'))}`)
                    .attr("target", "_blank")
                    .on("click", event => event.stopPropagation());
                
                textLink.append("text")
                    .attr("x", d => d._children ? -8 : 8)
                    .attr("dy", "0.31em")
                    .attr("text-anchor", d => d._children ? "end" : "start")
                    .text(d => `${d.data.name}${d._children ? ` (${d._children.length})` : ''}`)
                    .clone(true).lower()
                    .attr("stroke", "#fff");

                nodeEnter.on("mouseover", (event, d) => {
                    tooltip.transition().duration(200).style("opacity", 1);
                    tooltip.html(
                        `<strong>${d.data.name}</strong><br/>` +
                        `Type: ${d.data.type} (${d.data.reason})<br/>` +
                        `Timestamp: ${new Date(d.data.timestamp).toLocaleString()}`
                    );
                }).on("mousemove", (event) => {
                    tooltip.style("left", (event.pageX + 15) + "px")
                           .style("top", (event.pageY - 10) + "px");
                }).on("mouseout", () => {
                    tooltip.transition().duration(500).style("opacity", 0);
                });

                node.merge(nodeEnter).transition(transition)
                    .attr("transform", d => `translate(${d.y},${d.x})`)
                    .attr("fill-opacity", 1)
                    .attr("stroke-opacity", 1);
                
                node.exit().transition(transition).remove()
                    .attr("transform", d => `translate(${source.y},${source.x})`)
                    .attr("fill-opacity", 0)
                    .attr("stroke-opacity", 0);

                const link = g.selectAll("path.link").data(links, d => d.target.id);
                
                const linkEnter = link.enter().insert("path", "g")
                    .attr("class", "link")
                    .attr("d", d => {
                        const o = {x: source.x0, y: source.y0};
                        return d3.linkHorizontal()({source: o, target: o});
                    });

                link.merge(linkEnter).transition(transition)
                    .attr("d", d3.linkHorizontal().x(d => d.y).y(d => d.x));
                
                link.exit().transition(transition).remove()
                    .attr("d", d => {
                        const o = {x: source.x, y: source.y};
                        return d3.linkHorizontal()({source: o, target: o});
                    });

                currentRoot.eachBefore(d => {
                    d.x0 = d.x;
                    d.y0 = d.y;
                });
            }
        }
    </script>
</body>
</html>